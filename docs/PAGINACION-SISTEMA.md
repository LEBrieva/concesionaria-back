# üìñ Sistema de Paginaci√≥n H√≠brido

## üìã √çndice
1. [Introducci√≥n](#introducci√≥n)
2. [Arquitectura del Sistema](#arquitectura-del-sistema)
3. [Componentes Base (Shared)](#componentes-base-shared)
4. [Extensiones Espec√≠ficas por Entidad](#extensiones-espec√≠ficas-por-entidad)
5. [Implementaci√≥n por Capas](#implementaci√≥n-por-capas)
6. [Ejemplos de Uso](#ejemplos-de-uso)
7. [Beneficios del Patr√≥n H√≠brido](#beneficios-del-patr√≥n-h√≠brido)
8. [C√≥mo Extender a Nuevas Entidades](#c√≥mo-extender-a-nuevas-entidades)

---

## üéØ Introducci√≥n

El sistema de paginaci√≥n implementado sigue un **patr√≥n h√≠brido** que combina:
- **Base gen√©rica reutilizable** para funcionalidades comunes
- **Extensiones espec√≠ficas** para filtros complejos por entidad

Esto permite mantener consistencia en toda la aplicaci√≥n mientras se proporciona flexibilidad para necesidades espec√≠ficas de cada dominio.

### Caracter√≠sticas Principales
- ‚úÖ **Offset-based pagination** (page/limit)
- ‚úÖ **Filtros din√°micos** por entidad
- ‚úÖ **Type-safe** con TypeScript
- ‚úÖ **Validaciones autom√°ticas** con class-validator
- ‚úÖ **Reutilizable** y **escalable**
- ‚úÖ **Arquitectura limpia** respetando DDD

---

## üèóÔ∏è Arquitectura del Sistema

```
üì¶ Sistema de Paginaci√≥n
‚îú‚îÄ‚îÄ üåê Base Gen√©rica (Shared)
‚îÇ   ‚îú‚îÄ‚îÄ DTOs base
‚îÇ   ‚îú‚îÄ‚îÄ Interfaces base
‚îÇ   ‚îú‚îÄ‚îÄ Repositorio base
‚îÇ   ‚îî‚îÄ‚îÄ Servicio gen√©rico
‚îî‚îÄ‚îÄ üéØ Extensiones Espec√≠ficas
    ‚îú‚îÄ‚îÄ Autos (filtros complejos)
    ‚îî‚îÄ‚îÄ Usuarios (filtros simples)
```

### Flujo de Datos
```
Controller ‚Üí QueryService ‚Üí Repository ‚Üí Prisma ‚Üí Database
    ‚Üì           ‚Üì             ‚Üì
   DTO     Filters      Where Clause
```

---

## üåê Componentes Base (Shared)

### 1. DTOs Base (`src/modules/shared/dtos/pagination.dto.ts`)

```typescript
export class BasePaginationDto {
  page?: number = 1;           // P√°gina actual
  limit?: number = 15;         // Elementos por p√°gina
  orderBy?: string = 'createdAt';     // Campo de ordenamiento
  orderDirection?: 'asc' | 'desc' = 'desc';  // Direcci√≥n
}

export class PaginatedResponseDto<T> {
  data: T[];                   // Datos paginados
  pagination: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
    hasNext: boolean;
    hasPrev: boolean;
  };
}
```

### 2. Interfaces Base (`src/modules/shared/interfaces/base-repository.interface.ts`)

```typescript
export interface BaseFilters {
  incluirEliminados?: boolean;  // Filtro com√∫n para soft deletes
}

export interface IBaseRepository<T> {
  // M√©todos existentes...
  findWithPagination(
    page: number,
    limit: number,
    filters?: BaseFilters,
    orderBy?: string,
    orderDirection?: 'asc' | 'desc'
  ): Promise<BasePaginationResult<T>>;
}
```

### 3. Repositorio Base (`src/modules/shared/repositories/base.repository.ts`)

Implementa la l√≥gica gen√©rica de paginaci√≥n que funciona para cualquier entidad:

```typescript
async findWithPagination(
  page: number,
  limit: number,
  filters: BaseFilters = {},
  orderBy: string = 'createdAt',
  orderDirection: 'asc' | 'desc' = 'desc'
): Promise<BasePaginationResult<T>> {
  const skip = (page - 1) * limit;
  const where: any = {};
  
  if (!filters.incluirEliminados) {
    where.active = true;
  }
  
  // Ejecutar consultas en paralelo para optimizar rendimiento
  const [data, total] = await Promise.all([
    prismaTable.findMany({ where, skip, take: limit, orderBy }),
    prismaTable.count({ where })
  ]);
  
  return { data: data.map(this.toDomain), total };
}
```

### 4. Servicio Gen√©rico (`src/modules/shared/services/pagination.service.ts`)

```typescript
@Injectable()
export class PaginationService {
  async paginate<T extends BaseEntity>(
    repository: IBaseRepository<T>,
    paginationDto: BasePaginationDto,
    filters: BaseFilters = {}
  ): Promise<PaginatedResponseDto<T>> {
    const result = await repository.findWithPagination(/*...*/);
    return new PaginatedResponseDto(/*...*/);
  }
}
```

---

## üéØ Extensiones Espec√≠ficas por Entidad

### Autos - Filtros Complejos

#### 1. Filtros Espec√≠ficos (`src/modules/autos/domain/interfaces/auto-filters.interface.ts`)
```typescript
export interface AutoFilters extends BaseFilters {
  nombre?: string;
  marca?: Marca;              // Enum tipado
  modelo?: string;
  anio?: number;
  estado?: EstadoAuto;        // Enum tipado
  precioMin?: number;
  precioMax?: number;
  fechaCreacionDesde?: Date;
  fechaCreacionHasta?: Date;
  soloFavoritos?: boolean;
}
```

#### 2. DTO de Paginaci√≥n (`src/modules/autos/application/dtos/pagination/auto-pagination.dto.ts`)
```typescript
export class AutoPaginationDto extends BasePaginationDto {
  @IsOptional()
  @IsString()
  nombre?: string;

  @IsOptional()
  @IsEnum(Marca)              // Validaci√≥n autom√°tica del enum
  marca?: Marca;

  @IsOptional()
  @IsEnum(EstadoAuto)
  estado?: EstadoAuto;

  // ... m√°s filtros espec√≠ficos
}
```

### Usuarios - Filtros Simples

#### 1. Filtros Espec√≠ficos (`src/modules/usuarios/domain/interfaces/usuario-filters.interface.ts`)
```typescript
export interface UsuarioFilters extends BaseFilters {
  nombre?: string;
  apellido?: string;
  email?: string;
  rol?: RolUsuario;           // Enum tipado
}
```

---

## üîÑ Implementaci√≥n por Capas

### Capa de Dominio
```typescript
// Define el contrato espec√≠fico
export interface IAutoRepository extends IBaseRepository<Auto> {
  // M√©todos espec√≠ficos heredan de la base
  findWithAdvancedFilters(/*...*/): Promise<BasePaginationResult<Auto>>;
}
```

### Capa de Aplicaci√≥n
```typescript
@Injectable()
export class AutoQueryService {
  constructor(
    private readonly autoRepo: IAutoRepository,
    private readonly paginationService: PaginationService  // Servicio gen√©rico
  ) {}

  // Paginaci√≥n b√°sica (usa el servicio gen√©rico)
  async findWithBasicPagination(dto: BasePaginationDto) {
    return this.paginationService.paginate(this.autoRepo, dto);
  }

  // Paginaci√≥n avanzada (usa m√©todos espec√≠ficos)
  async findWithAdvancedFilters(filters: AutoPaginationDto) {
    // L√≥gica espec√≠fica de conversi√≥n y llamada al repositorio
  }
}
```

### Capa de Infraestructura
```typescript
@Injectable()
export class PrismaAutoRepository implements IAutoRepository {
  // Implementa tanto m√©todos gen√©ricos (heredados) como espec√≠ficos
  
  async findWithAdvancedFilters(/*...*/) {
    // Construye query espec√≠fica con filtros complejos
    const where: Prisma.AutoWhereInput = {};
    
    if (filters.marca) where.marca = filters.marca as Marca;
    if (filters.precioMin) where.precio = { gte: filters.precioMin };
    // ... m√°s filtros espec√≠ficos
  }
}
```

### Capa de Controladores
```typescript
@Controller('autos')
export class AutoController {
  // Endpoint b√°sico
  @Get('paginated/basic')
  async findWithBasicPagination(@Query() dto: BasePaginationDto) {
    return this.autoQueryService.findWithBasicPagination(dto);
  }

  // Endpoint avanzado
  @Get('paginated/advanced')
  async findWithAdvancedFilters(@Query() filters: AutoPaginationDto) {
    return this.autoQueryService.findWithAdvancedFilters(filters);
  }
}
```

---

## üöÄ Ejemplos de Uso

### Paginaci√≥n B√°sica
```bash
# P√°gina 1, 10 elementos, ordenado por fecha descendente
GET /autos/paginated/basic?page=1&limit=10&orderBy=createdAt&orderDirection=desc

# Respuesta
{
  "data": [...],
  "pagination": {
    "page": 1,
    "limit": 10,
    "total": 150,
    "totalPages": 15,
    "hasNext": true,
    "hasPrev": false
  }
}
```

### Filtros Avanzados - Autos
```bash
# Buscar autos Toyota disponibles entre $10,000 y $50,000
GET /autos/paginated/advanced?marca=TOYOTA&estado=DISPONIBLE&precioMin=10000&precioMax=50000&page=1&limit=12

# Solo autos favoritos
GET /autos/paginated/advanced?soloFavoritos=true&page=1&limit=6

# Buscar por nombre con rango de fechas
GET /autos/paginated/advanced?nombre=corolla&fechaCreacionDesde=2024-01-01&fechaCreacionHasta=2024-12-31
```

### Filtros Avanzados - Usuarios
```bash
# Buscar administradores por nombre
GET /usuarios/paginated/advanced?nombre=Juan&rol=ADMIN&page=1&limit=15

# Buscar por email
GET /usuarios/paginated/advanced?email=@gmail.com&incluirEliminados=false
```

---

## ‚úÖ Beneficios del Patr√≥n H√≠brido

### 1. **Reutilizaci√≥n de C√≥digo**
- Base gen√©rica elimina duplicaci√≥n
- L√≥gica com√∫n centralizada
- F√°cil mantenimiento

### 2. **Flexibilidad**
- Filtros espec√≠ficos por entidad
- Extensible sin afectar la base
- Diferentes niveles de complejidad

### 3. **Type Safety**
```typescript
// ‚ùå Antes
marca?: string  // Cualquier string
estado?: string // Cualquier string

// ‚úÖ Ahora
marca?: Marca      // Solo valores del enum
estado?: EstadoAuto // Solo valores del enum
```

### 4. **Validaciones Autom√°ticas**
```typescript
@IsEnum(Marca)    // Rechaza valores inv√°lidos autom√°ticamente
marca?: Marca;

@IsNumber()
@Min(0)          // Validaci√≥n de rango
precioMin?: number;
```

### 5. **Rendimiento Optimizado**
```typescript
// Consultas en paralelo
const [data, total] = await Promise.all([
  findMany(/*...*/),
  count(/*...*/)
]);
```

### 6. **Arquitectura Limpia**
- Separaci√≥n clara de responsabilidades
- Respeta principios DDD
- F√°cil testing y mantenimiento

---

## üîß C√≥mo Extender a Nuevas Entidades

### Paso 1: Crear Filtros Espec√≠ficos
```typescript
// src/modules/productos/domain/interfaces/producto-filters.interface.ts
export interface ProductoFilters extends BaseFilters {
  nombre?: string;
  categoria?: CategoriaProducto;
  precioMin?: number;
  precioMax?: number;
}
```

### Paso 2: Crear DTO de Paginaci√≥n
```typescript
// src/modules/productos/application/dtos/productos/pagination/producto-pagination.dto.ts
export class ProductoPaginationDto extends BasePaginationDto {
  @IsOptional()
  @IsString()
  nombre?: string;

  @IsOptional()
  @IsEnum(CategoriaProducto)
  categoria?: CategoriaProducto;
}
```

### Paso 3: Extender Repositorio
```typescript
// En el domain repository
export interface IProductoRepository extends IBaseRepository<Producto> {
  findWithAdvancedFilters(/*...*/): Promise<BasePaginationResult<Producto>>;
}

// En la implementaci√≥n Prisma
async findWithAdvancedFilters(/*...*/) {
  // Implementar filtros espec√≠ficos
}
```

### Paso 4: Extender Servicio
```typescript
@Injectable()
export class ProductoQueryService {
  constructor(
    private readonly productoRepo: IProductoRepository,
    private readonly paginationService: PaginationService
  ) {}

  // B√°sico (reutiliza servicio gen√©rico)
  async findWithBasicPagination(dto: BasePaginationDto) {
    return this.paginationService.paginate(this.productoRepo, dto);
  }

  // Avanzado (implementa l√≥gica espec√≠fica)
  async findWithAdvancedFilters(filters: ProductoPaginationDto) {
    // Implementar conversi√≥n y llamada espec√≠fica
  }
}
```

### Paso 5: Agregar Endpoints
```typescript
@Controller('productos')
export class ProductoController {
  @Get('paginated/basic')
  async findWithBasicPagination(@Query() dto: BasePaginationDto) {
    return this.productoQueryService.findWithBasicPagination(dto);
  }

  @Get('paginated/advanced')
  async findWithAdvancedFilters(@Query() filters: ProductoPaginationDto) {
    return this.productoQueryService.findWithAdvancedFilters(filters);
  }
}
```

---

## üìä Estructura de Archivos Final

```
src/modules/
‚îú‚îÄ‚îÄ shared/                                    # üåê BASE GEN√âRICA
‚îÇ   ‚îú‚îÄ‚îÄ dtos/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pagination.dto.ts                 # DTOs base
‚îÇ   ‚îú‚îÄ‚îÄ interfaces/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ base-repository.interface.ts      # Interfaces base
‚îÇ   ‚îú‚îÄ‚îÄ repositories/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ base.repository.ts                # Implementaci√≥n gen√©rica
‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îÇ       ‚îî‚îÄ‚îÄ pagination.service.ts             # Servicio gen√©rico
‚îÇ
‚îú‚îÄ‚îÄ autos/                                     # üéØ EXTENSI√ìN ESPEC√çFICA
‚îÇ   ‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ interfaces/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ auto-filters.interface.ts     # Filtros espec√≠ficos
‚îÇ   ‚îú‚îÄ‚îÄ application/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dtos/pagination/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auto-pagination.dto.ts        # DTO espec√≠fico
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ auto-query.service.ts         # Servicio extendido
‚îÇ   ‚îî‚îÄ‚îÄ infrastructure/
‚îÇ       ‚îú‚îÄ‚îÄ controllers/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ auto.controller.ts            # Endpoints
‚îÇ       ‚îî‚îÄ‚îÄ prisma/
‚îÇ           ‚îî‚îÄ‚îÄ prisma-auto.repository.ts     # Implementaci√≥n espec√≠fica
‚îÇ
‚îî‚îÄ‚îÄ usuarios/                                  # üéØ EXTENSI√ìN ESPEC√çFICA
    ‚îú‚îÄ‚îÄ domain/
    ‚îÇ   ‚îî‚îÄ‚îÄ interfaces/
    ‚îÇ       ‚îî‚îÄ‚îÄ usuario-filters.interface.ts  # Filtros espec√≠ficos
    ‚îú‚îÄ‚îÄ application/
    ‚îÇ   ‚îú‚îÄ‚îÄ dtos/usuarios/pagination/
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ usuario-pagination.dto.ts     # DTO espec√≠fico
    ‚îÇ   ‚îî‚îÄ‚îÄ services/
    ‚îÇ       ‚îî‚îÄ‚îÄ usuario-query.service.ts      # Servicio extendido
    ‚îî‚îÄ‚îÄ infrastructure/
        ‚îú‚îÄ‚îÄ controllers/
        ‚îÇ   ‚îî‚îÄ‚îÄ usuario.controller.ts         # Endpoints
        ‚îî‚îÄ‚îÄ prisma/
            ‚îî‚îÄ‚îÄ prisma-usuario.repository.ts  # Implementaci√≥n espec√≠fica
```

---

## üéØ Conclusi√≥n

El sistema de paginaci√≥n h√≠brido implementado proporciona:

1. **Consistencia** a trav√©s de la base gen√©rica
2. **Flexibilidad** mediante extensiones espec√≠ficas
3. **Escalabilidad** para futuras entidades
4. **Mantenibilidad** con c√≥digo reutilizable
5. **Type Safety** completo con TypeScript
6. **Performance** optimizado con consultas paralelas

Este patr√≥n permite que el sistema crezca de manera organizada y mantenible, respetando los principios de arquitectura limpia y DDD. 